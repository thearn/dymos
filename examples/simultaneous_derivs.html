

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Brachistochrone with Simultaneous Derivatives &#8212; dymos 0.11.1 documentation</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Double Integrator" href="double_integrator.html" />
    <link rel="prev" title="Brachistochrone: A simple optimal control example" href="brachistochrone.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="double_integrator.html" title="Double Integrator"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="brachistochrone.html" title="Brachistochrone: A simple optimal control example"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">dymos 0.11.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="examples.html" accesskey="U">Examples</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Brachistochrone with Simultaneous Derivatives</a><ul>
<li><a class="reference internal" href="#step-1-using-openmdao-s-simul-coloring-capability">Step 1: Using OpenMDAO’s Simul-Coloring Capability</a></li>
<li><a class="reference internal" href="#running-the-coloring-algorithm-separately">Running the coloring algorithm separately</a></li>
<li><a class="reference internal" href="#performance-comparison-with-and-without-simultaneous-derivatives">Performance comparison with and without simultaneous derivatives</a></li>
<li><a class="reference internal" href="#general-performance-tips-using-dymos">General Performance Tips Using Dymos</a><ul>
<li><a class="reference internal" href="#use-the-cscjacobian-as-the-top-level-jacobian-where-possible">1. Use the CSCJacobian as the top-level Jacobian where possible</a></li>
<li><a class="reference internal" href="#use-directsolver-as-the-top-level-linear-solver-where-possible">2. Use DirectSolver as the top-level linear solver where possible</a></li>
<li><a class="reference internal" href="#use-simultaneous-derivatives">3. Use simultaneous derivatives</a></li>
<li><a class="reference internal" href="#use-compressed-transcription-when-parallelization-is-not-a-concern">4. Use “compressed” transcription when parallelization is not a concern</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="brachistochrone.html"
                        title="previous chapter">Brachistochrone: A simple optimal control example</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="double_integrator.html"
                        title="next chapter">Double Integrator</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples/simultaneous_derivs.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="brachistochrone-with-simultaneous-derivatives">
<h1>Brachistochrone with Simultaneous Derivatives<a class="headerlink" href="#brachistochrone-with-simultaneous-derivatives" title="Permalink to this headline">¶</a></h1>
<p>A key feature of collocation algorithms such as high-order Gauss-Lobatto collocation or the
Radau pseudospectral method is that they exhibit a large degree of <em>sparsity</em> in the total
Jacobian.  By modeling the state-time histories as a series of polynomial segments, the collocation
defect constraints within each segment are largely dependent only on the state and control values
within the same segment.  State-of-the-art pseudospectral optimization tools such as SOCS, OTIS,
and GPOPS-II use the notion of <em>sparse finite differences</em> to perturb multiple independent variables
simultaneously when approximating the constraint Jacobian.  This can significantly reduce the
computational effort required to approximate the entire Jacobian via finite difference.</p>
<p>The unique way in which OpenMDAO assembles analytic derivatives across the problem allows us to
use a similar approach to provide the analytic constraint Jacobian.  This approach can reduce the time
required to solve moderately-sized optimal control problems by orders of magnitude and make the
convergence more robust.</p>
<p>OpenMDAO uses a simultaneous “coloring” algorithm to determine which variables can be perturbed
simultaneously to determine the total constraint Jacobian.  Variables in the same “color” each
impact a unique constraint, such that when all the variables are perturbed we can be assured that
any change in the constraint vector is due to at most one scalar variable.  Since OpenMDAO uses
a linear solver to assemble to total derivative Jacobian, coloring reduces the number of linear
solves from one per variable in forward mode to one per <em>color</em>. In the brachistochrone example
below this reduces the number of linear solves from 1001 to 9.  This capability makes problems
of moderate size run orders of magnitude faster, and can make intractably large problems tractable.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While some optimizers (SNOPT and IPOPT) are particularly adept at dealing with large, sparse
nonlinear programming problems, coloring can still benefit drivers which do not account for
sparsity (such as SLSQP) since it significantly reduces the cost of computing the Jacobian.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently OpenMDAO’s coloring algorithm requires that problems be setup using “forward” mode.</p>
</div>
<div class="section" id="step-1-using-openmdao-s-simul-coloring-capability">
<h2>Step 1: Using OpenMDAO’s Simul-Coloring Capability<a class="headerlink" href="#step-1-using-openmdao-s-simul-coloring-capability" title="Permalink to this headline">¶</a></h2>
<p>OpenMDAO supports dynamic simul-coloring, meaning it can automatically run the Jacobian coloring
algorithm before handing the problem to the optimizer.  To enable this capability, simply
add the following lines to the driver.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dynamic_simul_derivs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>To demonstrate this capability we’ll instantiate the brachistochrone problem with 200 3rd-order Gauss-Lobatto segments.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openmdao.api</span> <span class="kn">import</span> <span class="n">Problem</span><span class="p">,</span> <span class="n">Group</span><span class="p">,</span> <span class="n">pyOptSparseDriver</span><span class="p">,</span> <span class="n">DirectSolver</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.assert_utils</span> <span class="kn">import</span> <span class="n">assert_rel_error</span>
<span class="kn">from</span> <span class="nn">dymos</span> <span class="kn">import</span> <span class="n">Phase</span>
<span class="kn">from</span> <span class="nn">dymos.examples.brachistochrone.brachistochrone_ode</span> <span class="kn">import</span> <span class="n">BrachistochroneODE</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">Group</span><span class="p">())</span>

<span class="n">p</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">pyOptSparseDriver</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SLSQP&#39;</span>

<span class="c1"># Compute sparsity/coloring when run_driver is called</span>
<span class="n">p</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dynamic_simul_derivs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">phase</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">(</span><span class="s1">&#39;gauss-lobatto&#39;</span><span class="p">,</span>
              <span class="n">ode_class</span><span class="o">=</span><span class="n">BrachistochroneODE</span><span class="p">,</span>
              <span class="n">num_segments</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
              <span class="n">transcription_order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
              <span class="n">compressed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;phase0&#39;</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

<span class="n">phase</span><span class="o">.</span><span class="n">set_time_options</span><span class="p">(</span><span class="n">initial_bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">duration_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">phase</span><span class="o">.</span><span class="n">set_state_options</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">fix_initial</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fix_final</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">phase</span><span class="o">.</span><span class="n">set_state_options</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">fix_initial</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fix_final</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">phase</span><span class="o">.</span><span class="n">set_state_options</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">fix_initial</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">phase</span><span class="o">.</span><span class="n">add_control</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">rate_continuity</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">179.9</span><span class="p">)</span>

<span class="n">phase</span><span class="o">.</span><span class="n">add_design_parameter</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m/s**2&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">9.80665</span><span class="p">)</span>

<span class="c1"># Minimize time at the end of the phase</span>
<span class="n">phase</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">linear_solver</span> <span class="o">=</span> <span class="n">DirectSolver</span><span class="p">(</span><span class="n">assemble_jac</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;assembled_jac_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;csc&#39;</span>

<span class="n">p</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="n">p</span><span class="p">[</span><span class="s1">&#39;phase0.t_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">p</span><span class="p">[</span><span class="s1">&#39;phase0.t_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">p</span><span class="p">[</span><span class="s1">&#39;phase0.states:x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ys</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">nodes</span><span class="o">=</span><span class="s1">&#39;state_input&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="p">[</span><span class="s1">&#39;phase0.states:y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ys</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">nodes</span><span class="o">=</span><span class="s1">&#39;state_input&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="p">[</span><span class="s1">&#39;phase0.states:v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ys</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">9.9</span><span class="p">],</span> <span class="n">nodes</span><span class="o">=</span><span class="s1">&#39;state_input&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="p">[</span><span class="s1">&#39;phase0.controls:theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ys</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">100.5</span><span class="p">],</span> <span class="n">nodes</span><span class="o">=</span><span class="s1">&#39;control_input&#39;</span><span class="p">)</span>

<span class="c1"># Solve for the optimal trajectory</span>
<span class="n">p</span><span class="o">.</span><span class="n">run_driver</span><span class="p">()</span>

<span class="c1"># Test the results</span>
<span class="k">print</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>The simul_coloring script outputs the following information about our problem:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1 uncolored columns
5 columns in color 1
100 columns in color 2
100 columns in color 3
101 columns in color 4
101 columns in color 5
195 columns in color 6
197 columns in color 7
201 columns in color 8

Total colors vs. total size: 9 vs 1001  (99.1% improvement)
</pre></div>
</div>
</div>
<div class="section" id="running-the-coloring-algorithm-separately">
<h2>Running the coloring algorithm separately<a class="headerlink" href="#running-the-coloring-algorithm-separately" title="Permalink to this headline">¶</a></h2>
<p>OpenMDAO supports the ability to run the coloring algorithm “offline” and then provide the
data to the driver via a saved file.  This is potentially useful to users whose model is particularly
expensive to color, and whom aren’t changing the problem significantly between runs.  Consult
OpenMDAO’s documentation for more information on this feature.</p>
</div>
<div class="section" id="performance-comparison-with-and-without-simultaneous-derivatives">
<h2>Performance comparison with and without simultaneous derivatives<a class="headerlink" href="#performance-comparison-with-and-without-simultaneous-derivatives" title="Permalink to this headline">¶</a></h2>
<p>The following chart demonstrates the difference in timing that is achieved by
using simultaneous derivatives.  In this case the time required to solve the problem
dropped by over an order of magnitude.  For comparison, the performance of the
legacy optimal control software OTIS4 is also shown.  When using simul-derivs, the
performance of Dymos comes well within an order of magnitude (about 1.1x in this case) of
the performance of OTIS. This is despite the fact that Dymos supports analytic derivatives,
parallelization, and a non-conservative sparsity pattern which should close the gap further as
problem size grows.</p>
<p>This case has 600 constraints and 1001 variables, giving a total constraint Jaobian size of 600600.
Using a conservative sparsity pattern (assuming any variable in a segment can impact any constraint
in the same segment), OTIS computes that there are 7794 nonzero elements in the Jacobian.  The
non-conservative sparsity pattern calculated by OpenMDAO gives 4393 nonzero elements.</p>
<a class="reference internal image-reference" href="../_images/simul_derivs_perf_chart.png"><img alt="Performance of Dymos vs. OTIS in solving the brachistochrone problem." class="align-center" src="../_images/simul_derivs_perf_chart.png" style="width: 640.0px; height: 480.0px;" /></a>
</div>
<div class="section" id="general-performance-tips-using-dymos">
<h2>General Performance Tips Using Dymos<a class="headerlink" href="#general-performance-tips-using-dymos" title="Permalink to this headline">¶</a></h2>
<div class="section" id="use-the-cscjacobian-as-the-top-level-jacobian-where-possible">
<h3>1. Use the CSCJacobian as the top-level Jacobian where possible<a class="headerlink" href="#use-the-cscjacobian-as-the-top-level-jacobian-where-possible" title="Permalink to this headline">¶</a></h3>
<p>The CSCJacobian is a sparse Jacobian format used internally by OpenMDAO that can significantly
reduce memory requirements and signficantly improve performance of the Jacobian calculation.</p>
</div>
<div class="section" id="use-directsolver-as-the-top-level-linear-solver-where-possible">
<h3>2. Use DirectSolver as the top-level linear solver where possible<a class="headerlink" href="#use-directsolver-as-the-top-level-linear-solver-where-possible" title="Permalink to this headline">¶</a></h3>
<p>Unless the problem grows extremely large, using DirectSolver to solve the linear system which
computes the Jacobian can yield significant performance improvements.</p>
</div>
<div class="section" id="use-simultaneous-derivatives">
<h3>3. Use simultaneous derivatives<a class="headerlink" href="#use-simultaneous-derivatives" title="Permalink to this headline">¶</a></h3>
<p>As we’ve shown above, handling sparsity and simultaneous derivatives can significantly
improve performance.</p>
</div>
<div class="section" id="use-compressed-transcription-when-parallelization-is-not-a-concern">
<h3>4. Use “compressed” transcription when parallelization is not a concern<a class="headerlink" href="#use-compressed-transcription-when-parallelization-is-not-a-concern" title="Permalink to this headline">¶</a></h3>
<p>When providing the state and control values at segment boundaries, there are two options.
If a phase is declared with <cite>compressed=True</cite> (the default), the one value for the state/control
will be provided at the boundary, and used at the shared endpoint by both segments.
If <cite>compressed=False</cite>, then then two unique values are provided as design variables, with
state and control value continuity at the segment bound being enforced via a linear constraint.
Experience has shown that using compressed transcription signficantly improves performance by
reducing the number of variables and constraints given to the optimizer.  On the other hand,
when attempting to distribute the analysis across more than one processor using the separable
uncompressed transcription may give better performance.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="double_integrator.html" title="Double Integrator"
             >next</a> |</li>
        <li class="right" >
          <a href="brachistochrone.html" title="Brachistochrone: A simple optimal control example"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">dymos 0.11.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="examples.html" >Examples</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, National Aeronautics and Space Administration.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.8.
    </div>
  </body>
</html>