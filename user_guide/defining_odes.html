

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Defining ODEs &#8212; dymos 0.11.1 documentation</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Phases of a Trajectory" href="phases/phases.html" />
    <link rel="prev" title="Optimal Control" href="optimal_control.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="phases/phases.html" title="Phases of a Trajectory"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="optimal_control.html" title="Optimal Control"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">dymos 0.11.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="user_guide.html" accesskey="U">Dymos User’s Guide</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Defining ODEs</a><ul>
<li><a class="reference internal" href="#ode-options">ODE Options</a></li>
<li><a class="reference internal" href="#defining-an-ode-system">Defining an ODE System</a></li>
<li><a class="reference internal" href="#dimensioned-inputs-and-outputs">Dimensioned Inputs and Outputs</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="optimal_control.html"
                        title="previous chapter">Optimal Control</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="phases/phases.html"
                        title="next chapter">Phases of a Trajectory</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/user_guide/defining_odes.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="defining-odes">
<h1>Defining ODEs<a class="headerlink" href="#defining-odes" title="Permalink to this headline">¶</a></h1>
<p>Optimal control problems contain ordinary differential equations (ODE), or less frequently,
differential algebraic equations (DAE) that dictate the evolution of the state of the system.
Typically this evolution occurs in time, and the ODE represents equations of motion (EOM).
The equations of motion can define a variety of systems, not just mechanical ones.
In other fields they are sometimes referred to as <em>process equations</em> or
<em>plants</em>.</p>
<div class="math notranslate nohighlight">
\[\dot{\bar{x}} = f_{ode}(\bar{x},t,\bar{u},\bar{d})\]</div>
<p>To represent EOM, Dymos uses a standard OpenMDAO System (a Group or Component).  This System
takes some set of variables as input and computes outputs that include the time-derivatives of
the state variables <span class="math notranslate nohighlight">\(\bar{x}\)</span>.</p>
<div class="section" id="ode-options">
<h2>ODE Options<a class="headerlink" href="#ode-options" title="Permalink to this headline">¶</a></h2>
<p>Dymos needs to know how state, time, and control variables are to be connected to the System,
and needs to know which outputs to use as state time-derivatives.  To do so, the System class
is wrapped with decorators that declare the time, state, and parameter metadata.</p>
<p>For example, lets consider the ODE for the simple Brachistochrone problem.  In this problem
we have three state variables (<cite>x</cite>, <cite>y</cite>, and <cite>v</cite>) and two parameters that can potentially
be used as controls or connected to external sources (<cite>theta</cite> and <cite>g</cite>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openmdao.api</span> <span class="kn">import</span> <span class="n">ExplicitComponent</span>
<span class="kn">from</span> <span class="nn">dymos</span> <span class="kn">import</span> <span class="n">declare_time</span><span class="p">,</span> <span class="n">declare_state</span><span class="p">,</span> <span class="n">declare_parameter</span>

<span class="nd">@declare_time</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
<span class="nd">@declare_state</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rate_source</span><span class="o">=</span><span class="s1">&#39;xdot&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="nd">@declare_state</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">rate_source</span><span class="o">=</span><span class="s1">&#39;ydot&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="nd">@declare_state</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">rate_source</span><span class="o">=</span><span class="s1">&#39;vdot&#39;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m/s&#39;</span><span class="p">)</span>
<span class="nd">@declare_parameter</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
<span class="nd">@declare_parameter</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;m/s**2&#39;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">BrachistochroneODE</span><span class="p">(</span><span class="n">ExplicitComponent</span><span class="p">):</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>The options for <cite>declare_time</cite> are as follows:</p>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="6%" />
<col width="14%" />
<col width="14%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Default</th>
<th class="head">Acceptable Values</th>
<th class="head">Acceptable Types</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>targets</td>
<td>[]</td>
<td>N/A</td>
<td>[‘Iterable’]</td>
<td>Target path(s) for the time variable, relative to the top-level system.</td>
</tr>
<tr class="row-odd"><td>units</td>
<td>None</td>
<td>N/A</td>
<td>[‘str’]</td>
<td>Units for time.</td>
</tr>
</tbody>
</table>
<p>Note: Options can be passed as keyword arguments at initialization.</p>
<p>For <cite>declare_state</cite>, the following options are available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="9%" />
<col width="13%" />
<col width="12%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Default</th>
<th class="head">Acceptable Values</th>
<th class="head">Acceptable Types</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>name</td>
<td><strong>Required</strong></td>
<td>N/A</td>
<td>[‘str’]</td>
<td>The name of the state variable.</td>
</tr>
<tr class="row-odd"><td>rate_source</td>
<td><strong>Required</strong></td>
<td>N/A</td>
<td>[‘str’]</td>
<td>The path to the output in the system which is the time-derivative of the state.</td>
</tr>
<tr class="row-even"><td>shape</td>
<td>(1,)</td>
<td>N/A</td>
<td>[‘tuple’]</td>
<td>The shape of the variable (ignoring the time-dimension along the first axis).</td>
</tr>
<tr class="row-odd"><td>targets</td>
<td>[]</td>
<td>N/A</td>
<td>[‘Iterable’]</td>
<td>Target paths for the state, relative to the top-level system.</td>
</tr>
<tr class="row-even"><td>units</td>
<td>None</td>
<td>N/A</td>
<td>[‘str’]</td>
<td>The units of the parameter.</td>
</tr>
</tbody>
</table>
<p>Note: Options can be passed as keyword arguments at initialization.</p>
<p>And finally, the following options exist for parameters:</p>
<table border="1" class="docutils">
<colgroup>
<col width="2%" />
<col width="3%" />
<col width="4%" />
<col width="4%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Default</th>
<th class="head">Acceptable Values</th>
<th class="head">Acceptable Types</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>dynamic</td>
<td>True</td>
<td>N/A</td>
<td>[‘bool’]</td>
<td>If True, the value of the shape of the parameter will be (num_nodes, …), allowing the variable to be used as either a static or dynamic control.  This impacts the shape of the partial derivatives matrix.  Unless a parameter is large and broadcasting a value to each individual node would be inefficient, users should stick to the default value of True.</td>
</tr>
<tr class="row-odd"><td>name</td>
<td><strong>Required</strong></td>
<td>N/A</td>
<td>[‘str’]</td>
<td>The name of the parameter.</td>
</tr>
<tr class="row-even"><td>shape</td>
<td>(1,)</td>
<td>N/A</td>
<td>[‘tuple’]</td>
<td>The shape of the variable (ignoring the time-dimension along the first axis).</td>
</tr>
<tr class="row-odd"><td>targets</td>
<td><strong>Required</strong></td>
<td>N/A</td>
<td>[‘Iterable’]</td>
<td>Target paths for the parameter, relative to the top-level system.</td>
</tr>
<tr class="row-even"><td>units</td>
<td>None</td>
<td>N/A</td>
<td>[‘str’]</td>
<td>The units of the parameter.</td>
</tr>
</tbody>
</table>
<p>Note: Options can be passed as keyword arguments at initialization.</p>
</div>
<div class="section" id="defining-an-ode-system">
<h2>Defining an ODE System<a class="headerlink" href="#defining-an-ode-system" title="Permalink to this headline">¶</a></h2>
<p>In addition to specifying the ODE Options, a system used as an ODE is required to have a metadata
entry called <cite>num_nodes</cite>.  When evaluating the dynamics, these systems will receive time, states,
controls, and other inputs as <em>vectorized</em> values, where item in the vector represents the variable
value at a discrete time in the trajectory.</p>
<p>The nodes are discretization or collocation locations in the polynomials which represent
each segment.  The number of nodes in a given phase (to be evaluated by the ODE system) is determined
by the number of segments in the phase and the polynomial order in each segment.  When Dymos instantiates
the ODE system it provides the total number of nodes at which evaluation is required to the ODE system.
Thus, at a minimum, the <cite>initialize</cite> method of components for an ODE system typically look something
like this:</p>
<p>The inputs and outputs of the system are expected to provide a scalar or dimensioned
value <em>at each node</em>.  Vectorization of the component via numpy adds a significant performance increase
compared to using a for loop to cycle through calculations at each node.  It’s important to remember
that vectorized data is going to be coming in, this is especially important for defining partials.
From the perspective of the ODE system, the outputs at some time <cite>t</cite> only depend on the values
of the input variables at time <cite>t</cite>.  When the output variables are scalar at any given time, this
results in components whose Jacobian matrices are diagonal.  This large degree of sparsity leads
to computational advantages when using sparse-aware optimizers like SNOPT.  Users should declare
the partial derivatives of their components to be sparse (by specifying nonzero rows and columns)
whenever possible.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyODEComponent</span><span class="p">(</span><span class="n">ExplicitComponent</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<p>For example, if <cite>MyODEComponent</cite> is to compute the linear function <span class="math notranslate nohighlight">\(y = a * x + b\)</span> then the
setup, compute, and compute partials methods might look like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">def setup(self):</span>
<span class="go">    nn = self.metadata[&#39;num_nodes&#39;]</span>

<span class="go">    self.add_input(&#39;a&#39;, shape=(nn,), units=&#39;m&#39;)</span>
<span class="go">    self.add_input(&#39;x&#39;, shape=(nn,), units=&#39;1/s&#39;)</span>
<span class="go">    self.add_input(&#39;b&#39;, shape=(nn,), units=&#39;m/s&#39;)</span>

<span class="go">    self.add_output(&#39;y&#39;, shape=(nn,), units=&#39;m/s&#39;)</span>

<span class="go">    r = c = np.arange(nn)</span>
<span class="go">    self.declare_partials(of=&#39;y&#39;, wrt=&#39;a&#39;, rows=r, cols=c)</span>
<span class="go">    self.declare_partials(of=&#39;y&#39;, wrt=&#39;x&#39;, rows=r, cols=c)</span>
<span class="go">    self.declare_partials(of=&#39;y&#39;, wrt=&#39;b&#39;, rows=r, cols=c, val=1.0)</span>

<span class="go">def compute(self, inputs, outputs):</span>
<span class="go">    a = inputs[&#39;a&#39;]</span>
<span class="go">    x = inputs[&#39;x&#39;]</span>
<span class="go">    b = inputs[&#39;b&#39;]</span>

<span class="go">    outputs[&#39;y&#39;] = a * x + b</span>

<span class="go">def compute_partials(self, inputs, outputs, partials):</span>
<span class="go">    a = inputs[&#39;a&#39;]</span>
<span class="go">    x = inputs[&#39;x&#39;]</span>
<span class="go">    b = inputs[&#39;b&#39;]</span>

<span class="go">    partials[&#39;y&#39;, &#39;a&#39;] = x</span>
<span class="go">    partials[&#39;y&#39;, &#39;x&#39;] = a</span>
</pre></div>
</div>
<p>A few things to note here.  We can use the <cite>shape</cite> or <cite>val</cite> argument of <cite>add_input</cite> and <cite>add_output</cite>
to dimension each variable.  In this case each variable is assumed to be a scalar at each point in
time (each node).  We use the <cite>rows</cite> and <cite>cols</cite> arguments of <cite>declare_partials</cite> to provide the sparsity.
Here using <cite>arange(nn)</cite> for both gives us a diagonal jacobian with <cite>nn</cite> rows and <cite>nn</cite> columns.  Since
the number of nonzero values in the jacobian is <cite>nn</cite>, we only need to provide <cite>nn</cite> values in the
<cite>compute_partials</cite> method.  It will automatically fill them into the sparse jacobian matrix, in
row-major order.</p>
<p>In this example, the partial of <cite>y</cite> with respect to <cite>b</cite> is linear, so we can simply provide it in
the <cite>declare_partials</cite> call rather than reassigning it every time <cite>compute_partials</cite> is called.
The provided scalar value of <cite>1.0</cite> is broadcast to all <cite>nn</cite> values of the Jacobian matrix.</p>
</div>
<div class="section" id="dimensioned-inputs-and-outputs">
<h2>Dimensioned Inputs and Outputs<a class="headerlink" href="#dimensioned-inputs-and-outputs" title="Permalink to this headline">¶</a></h2>
<p>The above example assumes all inputs and outputs are scalar at each node.  Sometimes the user may
encounter a situation in which the inputs and/or outputs are vectors, matrices, or tensors at
each node.  In this case the dimension of the variable is <cite>num_nodes</cite>, with the dimension of the
variable at a single node filling out the remaining indices. A 3-vector is thus dimensioned
<cite>(num_nodes, 3)</cite>, while a 3 x 3 matrix would be sized <cite>(num_nodes, 3, 3)</cite>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="phases/phases.html" title="Phases of a Trajectory"
             >next</a> |</li>
        <li class="right" >
          <a href="optimal_control.html" title="Optimal Control"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">dymos 0.11.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="user_guide.html" >Dymos User’s Guide</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, National Aeronautics and Space Administration.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.8.
    </div>
  </body>
</html>